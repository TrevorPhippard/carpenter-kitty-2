version: "3.9"

services:
  # ================================
  # ðŸŸ¦ Go Microservices
  # ================================

  user-service:
    build:
      context: ./services/user
      dockerfile: Dockerfile
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      PORT: 50051
      POSTGRES_HOST: user-db
      POSTGRES_PORT: 5432
      POSTGRES_USER: user_admin
      POSTGRES_PASSWORD: Passw0rd123
      POSTGRES_DB: userdb
    networks:
      - backend
    depends_on:
      user-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50051"]
      interval: 10s
      timeout: 5s
      retries: 5

  user-service-sidecar:
    image: envoyproxy/envoy:v1.30.0
    depends_on:
      - user-service
    volumes:
      - ./services/user/envoy.yaml:/etc/envoy/envoy.yaml
    command: ["/bin/sh", "-c", "mkdir -p /etc/envoy && envoy -c /etc/envoy/envoy.yaml --log-level debug"]
    ports:
      - "50051:50051"   # public listener
      - "9901:9901"     # admin
    networks:
      - backend

  post-service:
    build:
      context: ./services/post
      dockerfile: Dockerfile
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      PORT: 50052
      POST_DB_URI: mongodb://post-db:27017/postdb
    networks:
      - backend
    depends_on:
      post-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50052"]
      interval: 10s
      timeout: 5s
      retries: 5

  post-service-sidecar:
    image: envoyproxy/envoy:v1.30.0
    depends_on:
      - post-service
    volumes:
      - ./services/post/envoy.yaml:/etc/envoy/envoy.yaml
    command: ["/bin/sh", "-c", "mkdir -p /etc/envoy && envoy -c /etc/envoy/envoy.yaml --log-level debug"]
    ports:
      - "50052:50052"
      - "9902:9901"   # unique admin port
    networks:
      - backend

  connections-service:
    build:
      context: ./services/connections
      dockerfile: Dockerfile
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      PORT: 50053
      NEO4J_URI: bolt://connections-db:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: Neo4jPass123!
    networks:
      - backend
    depends_on:
      connections-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50053"]
      interval: 10s
      timeout: 5s
      retries: 5

  connections-service-sidecar:
    image: envoyproxy/envoy:v1.30.0
    depends_on:
      - connections-service
    volumes:
      - ./services/connections/envoy.yaml:/etc/envoy/envoy.yaml
    command: ["/bin/sh", "-c", "mkdir -p /etc/envoy && envoy -c /etc/envoy/envoy.yaml --log-level debug"]
    ports:
      - "50053:50053"
      - "9903:9901"   # unique admin port
    networks:
      - backend

  # ================================
  # ðŸŸ§ API Gateway (Envoy)
  # ================================
  gateway:
    image: envoyproxy/envoy:v1.30.0
    container_name: envoy-gateway
    depends_on:
      - user-service-sidecar
      - post-service-sidecar
      - connections-service-sidecar
    volumes:
      - ./gateway/http.yaml:/etc/envoy/envoy.yaml
    command: ["/bin/sh", "-c", "mkdir -p /etc/envoy && envoy -c /etc/envoy/envoy.yaml --log-level debug"]
    ports:
      - "8080:8080"   # public gateway
      - "9900:9900"   # admin
    networks:
      - backend

  # ================================
  # ðŸŸª Databases
  # ================================

  user-db:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: user_admin
      POSTGRES_PASSWORD: Passw0rd123
      POSTGRES_DB: userdb
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_admin"]
      interval: 5s
      timeout: 5s
      retries: 5

  post-db:
    image: mongo:7
    restart: always
    volumes:
      - post-db-data:/data/db
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "mongo --eval 'db.adminCommand(\"ping\")' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  connections-db:
    image: neo4j:5.10
    restart: always
    environment:
      NEO4J_AUTH: neo4j/Neo4jPass123!
      NEO4J_ACCEPT_LICENSE_AGREEMENT: yes
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - connections-db-data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p Neo4jPass123! 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # ðŸŸ© Consul
  # ================================
  consul:
    image: hashicorp/consul:1.21.1
    container_name: consul
    command: "agent -dev -client=0.0.0.0"
    ports:
      - "8500:8500"
    networks:
      - backend

  # ================================
  # ðŸŸ¨ Admin Tools
  # ================================
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8083:80"
    networks:
      - frontend
      - backend
    depends_on:
      - user-db

# ================================
# ðŸ”µ Volumes
# ================================
volumes:
  user-db-data:
  post-db-data:
  connections-db-data:

# ================================
# ðŸŸ  Networks
# ================================
networks:
  frontend:
  backend:
