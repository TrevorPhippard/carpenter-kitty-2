services:
  # ================================
  # Go Microservices
  # ================================
  user-service:
    build:
      context: ./services/user
      dockerfile: Dockerfile
    environment:
      PORT: 50051
      POSTGRES_HOST: user-db
      POSTGRES_PORT: 5432
      POSTGRES_USER: user_admin
      POSTGRES_PASSWORD: Passw0rd123
      POSTGRES_DB: userdb
    networks:
      - backend
    ports:
      - "50051:50051"   # Expose gRPC port to host
    depends_on:
      user-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50051", "-connect-timeout=5s"]
      interval: 10s
      timeout: 5s
      retries: 5

  post-service:
    build:
      context: ./services/post
      dockerfile: Dockerfile
    environment:
      PORT: 50052
      POST_DB_URI: mongodb://post-db:27017/postdb
    networks:
      - backend
    ports:
      - "50052:50052"   # Expose gRPC port to host
    depends_on:
      post-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50052", "-connect-timeout=5s"]
      interval: 10s
      timeout: 5s
      retries: 5

  connections-service:
    build:
      context: ./services/connection
      dockerfile: Dockerfile
    environment:
      PORT: 50053
      NEO4J_URI: bolt://connections-db:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: Neo4jPass123!
    networks:
      - backend
    ports:
      - "50053:50053"
    depends_on:
      connections-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=:50053", "-connect-timeout=5s"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # API Gateway
  # ================================

  # ================================
  # Databases
  # ================================
  user-db:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: user_admin
      POSTGRES_PASSWORD: Passw0rd123
      POSTGRES_DB: userdb
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_admin"]
      interval: 5s
      timeout: 5s
      retries: 5

  post-db:
    image: mongo:7
    restart: always
    volumes:
      - post-db-data:/data/db
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "mongo --eval 'db.adminCommand(\"ping\")' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  connections-db:
    image: neo4j:5.10
    restart: always
    environment:
      NEO4J_AUTH: neo4j/Neo4jPass123!
      NEO4J_ACCEPT_LICENSE_AGREEMENT: yes
      NEO4J_dbms_memory_pagecache_size: 1G
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 512m
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - connections-db-data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p Neo4jPass123! 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # Cache (Optional)
  # ================================
  # cache:
  #   image: redis:7-alpine
  #   container_name: redis-cache

  #   networks:
  #     - backend
  #   expose:
  #     - "6379"
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3

  # ================================
  # Monitoring & Logging
  # ================================
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: prometheus
  #   volumes:
  #     - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
  #   ports:
  #     - "9090:9090"
  #   networks:
  #     - backend

  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: grafana
  #   ports:
  #     - "3001:3000"
  #   environment:
  #     GF_SECURITY_ADMIN_USER: admin
  #     GF_SECURITY_ADMIN_PASSWORD: admin
  #   depends_on:
  #     - prometheus
  #   networks:
  #     - backend

  # loki:
  #   image: grafana/loki:2.8.2
  #   container_name: loki
  #   ports:
  #     - "3100:3100"
  #   networks:
  #     - backend
  # ================================
  # DB Admin Tools
  # ================================
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8083:80"
    networks:
      - frontend
      - backend
    depends_on:
      - user-db

# ================================
# Volumes
# ================================
volumes:
  user-db-data:
  post-db-data:
  connections-db-data:

# ================================
# Networks
# ================================
networks:
  frontend:
  backend:
