services:
  # ================================
  # Go Microservices
  # ================================
  user-service:
    build:
      context: ../services/user
      dockerfile: Dockerfile
    environment:
      PORT: ${USER_SERVICE_PORT}
      POSTGRES_HOST: user-db
      POSTGRES_PORT: ${USER_DB_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    networks:
      - backend
    depends_on:
      - user-db
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://user-service:${USER_SERVICE_PORT}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  post-service:
    build:
      context: ../services/post
      dockerfile: Dockerfile
    environment:
      PORT: ${POST_SERVICE_PORT}
      POST_DB_URI: mongodb://post-db:27017/${MONGO_DB_NAME}
    networks:
      - backend
    depends_on:
      - post-db
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://post-service:${POST_SERVICE_PORT}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  connections-service:
    build:
      context: ../services/connection
      dockerfile: Dockerfile
    environment:
      PORT: ${CONNECTIONS_SERVICE_PORT}
      NEO4J_URI: bolt://connections-db:7687
      NEO4J_USER: ${NEO4J_USER}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
    networks:
      - backend
    depends_on:
      - connections-db
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://connections-service:${CONNECTIONS_SERVICE_PORT}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # Databases
  # ================================
  user-db:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  post-db:
    image: mongo:7
    restart: always
    volumes:
      - post-db-data:/data/db
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "mongo --eval 'db.adminCommand(\"ping\")' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  connections-db:
    image: neo4j:5.10
    restart: always
    environment:
      NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PASSWORD}
      NEO4J_ACCEPT_LICENSE_AGREEMENT: yes
      NEO4J_dbms_memory_pagecache_size: 1G
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 512m
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - connections-db-data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # API Gateway
  # ================================
  gateway:
    build:
      context: ../gateway
      dockerfile: Dockerfile
    ports:
      - "${GATEWAY_PORT}:${GATEWAY_PORT}"
    environment:
      USER_SERVICE_HOST: user-service
      USER_SERVICE_PORT: ${USER_SERVICE_PORT}
      POST_SERVICE_HOST: post-service
      POST_SERVICE_PORT: ${POST_SERVICE_PORT}
      CONNECTIONS_HOST: connections-service
      CONNECTIONS_PORT: ${CONNECTIONS_SERVICE_PORT}
    networks:
      - backend
      - frontend
    depends_on:
      - user-service
      - post-service
      - connections-service
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://gateway:${GATEWAY_PORT}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # DB Admin Tools
  # ================================
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8083:80"
    networks:
      - frontend
      - backend
    depends_on:
      - user-db

# ================================
# Cache (Optional)
# ================================
# cache:
#   image: redis:7-alpine
#   container_name: redis-cache

#   networks:
#     - backend
#   expose:
#     - "6379"
#   healthcheck:
#     test: ["CMD", "redis-cli", "ping"]
#     interval: 10s
#     timeout: 5s
#     retries: 3

# ================================
# Monitoring & Logging
# ================================
# prometheus:
#   image: prom/prometheus:latest
#   container_name: prometheus
#   volumes:
#     - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
#   ports:
#     - "9090:9090"
#   networks:
#     - backend

# grafana:
#   image: grafana/grafana:latest
#   container_name: grafana
#   ports:
#     - "3001:3000"
#   environment:
#     GF_SECURITY_ADMIN_USER: admin
#     GF_SECURITY_ADMIN_PASSWORD: admin
#   depends_on:
#     - prometheus
#   networks:
#     - backend

# loki:
#   image: grafana/loki:2.8.2
#   container_name: loki
#   ports:
#     - "3100:3100"
#   networks:
#     - backend


# ================================
# Volumes
# ================================
volumes:
  user-db-data:
  post-db-data:
  connections-db-data:

# ================================
# Networks
# ================================
networks:
  frontend:
  backend:
